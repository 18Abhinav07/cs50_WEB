{% extends "network/layout.html" %}

{% block body %}

{% if user.is_authenticated %}
    <div class="card" style="margin:3rem">
    <h5 class="card-header">New post</h5>
        <form method="POST" action="{% url 'index' %}">
            {% csrf_token %}
            <div class="form-group">
                <textarea class="form-control" name="content" rows="3" placeholder="Write your post here"></textarea>
            </div>
            <div class="form-group">   
                <button type="submit" class="btn btn-primary" style="margin-left:50%">Post</button>
            </div>
         
        </form>
    </div>

{% else %}
    <div class="alert alert-warning" role="alert">
        You are not logged in. Please <a href="{% url 'login' %}">log in</a> or <a href="{% url 'register' %}">register</a>.
    </div>

{% endif %}
   {% if values %}
        {% for val in values %}
        {% with post=val.0 like=val.1 dislike=val.2 %}
            <div class="card" style="margin:1rem">
                <div class="card-body">
                    <div class="card-body d-flex justify-content-between">
                <a href="{% url 'user_info' pk=post.id %}" class="link-primary link-underline-opacity-0"><h5 class="card-title"><strong>{{ post.user }}</strong></h5></a>
                
                {% if post.user == request.user %}
                <button type="submit" class="btn btn-primary edit-btn" data-post-id="{{ post.id }}">Edit</button>
                {% endif %}

                    </div>

                <p class="card-text post-content" data-post-id="{{ post.id }}" style="padding:2rem; border:solid 1px rgb(156, 155, 155); border-radius:10px;">{{ post.content }}</p>
               
                <div class="edit-container" data-post-id="{{ post.id }}">
                    <textarea class="edit-textarea form-control mb-3" rows="5"></textarea>
                    <button class="btn btn-danger save-btn">Save</button>
                </div>

                  <style>

                    .edit-container {
                    width: 100%;
                    flex-direction: vertical;
                    display: none;
                    }

                    .edit-textarea {
                    resize: vertical;
                    font-size: 16px;
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    margin-right:2rem;
                    }

                    .save-btn {
                     border-radius: 50px;
                    
                    }

                  </style>

                </div>
                <ul class="list-group list-group-flush">
                <li class="list-group-item">{{ post.timestamp }}</li>
                <li class="list-group-item">&#10084; {{like}} 
                </li>
                <li class="list-group-item">&#128078; {{dislike}} 
                </li>
                <li class="list-group-item card-link">Comment</li>
                <//ul>
            </div>
            {% endwith %}
        {% endfor %}

        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
        {% endif %}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">Next</a>
        {% endif %}
                
   {% else %}
   <div class="alert alert-primary" role="alert">
    There are no posts made. Please<a href="{% url 'login' %}"> log in</a> or <a href="{% url 'register' %}">register</a> to make a post.
    </div>


    <section class="py-4 py-xl-5">
        <div class="container">
            <div class="bg-dark border rounded border-0 border-dark overflow-hidden">
                <div class="row g-0">
                    <div class="col-md-6">
                        <div class="text-white p-4 p-md-5">
                            <h2 class="fw-bold text-white mb-3">NETWORK</h2>
                            <p class="mb-4">A all in one place to make posts.</p>
                            <div class="my-3"><a class="btn btn-primary btn-lg me-2" role="button" href="{% url 'login' %}">Login</a><a class="btn btn-light btn-lg" role="button" href="{% url 'register' %}">Register</a></div>
                        </div>
                    </div>
                    <div class="col-md-6 order-first order-md-last" style="min-height: 250px;"><img class="w-100 h-100 fit-cover" src= "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS5S63gda2DY0pwA0LAWxPK_SMZ0WRbQnV3kw&s"/></div>
                </div>
            </div>
        </div>
    </section>

   {% endif %}
    
  
<script>
   // Get all "Edit" buttons
const editBtns = document.querySelectorAll('.edit-btn');

// Add click event listener to each "Edit" button
editBtns.forEach(btn => {
    btn.addEventListener('click', editPost);
});

// Function to handle the "Edit" action
function editPost(event) {
    const btn = event.target;
    const postId = btn.dataset.postId;
    const postContent = document.querySelector(`.post-content[data-post-id="${postId}"]`);
    const editContainer = document.querySelector(`.edit-container[data-post-id="${postId}"]`);

    // Show the edit container and populate the textarea with the post content
    editContainer.style.display = 'flex';
    const textarea = editContainer.querySelector('.edit-textarea');
    textarea.value = postContent.textContent;

    // Add event listener to the "Save" button
    const saveBtn = editContainer.querySelector('.save-btn');
    saveBtn.addEventListener('click', () => savePost(postId, textarea.value));
}

// Function to handle the "Save" action
function savePost(postId, newContent) {
    // Send a fetch request to the server to update the post content
    fetch(`/update_post/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ content: newContent }),
    })
    .then(response => {
        if (response.ok) {
            // Update the post content on the page
            const postContentEl = document.querySelector(`.post-content[data-post-id="${postId}"]`);
            postContentEl.textContent = newContent;

            // Hide the edit container
            const editContainer = document.querySelector(`.edit-container[data-post-id="${postId}"]`);
            editContainer.style.display = 'none';
        } else {
            // Handle error
            console.error('Failed to update post');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
   </script> 

{% endblock %}

